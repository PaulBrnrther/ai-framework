#!/usr/bin/env python3
"""Add a repo entry to a ticket YAML file under a given branch."""

import sys

yaml_file, branch, repo = sys.argv[1], sys.argv[2], sys.argv[3]

with open(yaml_file, 'r') as f:
    content = f.read()

# Check if repo already listed
if f"      {repo}:" in content:
    sys.exit(0)

# Replace "repos: {}" with actual repo entry
old = "    repos: {}"
new = f"    repos:\n      {repo}:\n        plugins: []"
if old in content:
    content = content.replace(old, new, 1)
else:
    # repos already has entries â€” append before next branch or end of file
    lines = content.split('\n')
    insert_idx = None
    in_branch = False
    in_repos = False
    for i, line in enumerate(lines):
        if line.strip().startswith(branch):
            in_branch = True
        elif in_branch and line.strip() == 'repos:':
            in_repos = True
        elif in_branch and in_repos:
            if line and not line.startswith('        ') and not line.startswith('      '):
                insert_idx = i
                break
    if insert_idx is None:
        insert_idx = len(lines)
    lines.insert(insert_idx, f"      {repo}:\n        plugins: []")
    content = '\n'.join(lines)

with open(yaml_file, 'w') as f:
    f.write(content)
