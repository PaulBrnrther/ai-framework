#!/usr/bin/env bash
set -euo pipefail

# ticket plugins — pick plugins from current repo to add to ticket YAML
#
# Usage: ticket plugins  (fzf multi-select picker)
# Must be run from inside a worktree of the active ticket.

TICKETS_DIR="$HOME/.tickets"
REPOS_DIR="$HOME/knime/repos"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ -z "${ACTIVE_TICKET:-}" ]; then
  echo "Error: No active ticket." >&2
  exit 1
fi

YAML_FILE="$TICKETS_DIR/$ACTIVE_TICKET.yaml"
if [ ! -f "$YAML_FILE" ]; then
  echo "Error: Ticket file not found: $YAML_FILE" >&2
  exit 1
fi

# Detect current repo + branch from PWD
REPO=""
BRANCH=""
for repo_git in "$REPOS_DIR"/*.git; do
  [ -d "$repo_git" ] || continue
  repo_name=$(basename "$repo_git" .git)
  if [[ "$PWD" == "$repo_git/branches/"* ]]; then
    REPO="$repo_name"
    branch_and_rest="${PWD#"$repo_git/branches/"}"
    # Branch can contain slashes — match against YAML branches
    while IFS= read -r yaml_branch; do
      if [[ "$branch_and_rest" == "$yaml_branch"* ]]; then
        BRANCH="$yaml_branch"
        break
      fi
    done < <(grep -E '^\s{2}([a-z]+/)?[A-Z]+-[0-9]+-' "$YAML_FILE" | sed 's/://;s/^[[:space:]]*//')
    break
  fi
done

if [ -z "$REPO" ]; then
  echo "Error: Not inside a ticket worktree. cd to a repo worktree first." >&2
  exit 1
fi

if [ -z "$BRANCH" ]; then
  BRANCH=$(grep -E '^\s{2}([a-z]+/)?[A-Z]+-[0-9]+-' "$YAML_FILE" | head -1 | sed 's/://;s/^[[:space:]]*//')
fi

WORKTREE_PATH="$REPOS_DIR/$REPO.git/branches/$BRANCH"

# Get existing plugins from YAML (via shared helper)
EXISTING=$("$SCRIPT_DIR/parse-ticket-plugins" "$YAML_FILE" "$BRANCH" "$REPO")

# List plugin directories in the worktree (org.* and com.*)
AVAILABLE=()
for dir in "$WORKTREE_PATH"/org.* "$WORKTREE_PATH"/com.*; do
  [ -d "$dir" ] || continue
  name=$(basename "$dir")
  # Skip if already in YAML
  if echo "$EXISTING" | grep -qx "$name" 2>/dev/null; then
    continue
  fi
  AVAILABLE+=("$name")
done

if [ ${#AVAILABLE[@]} -eq 0 ]; then
  existing_count=$(echo "$EXISTING" | grep -c . 2>/dev/null || echo 0)
  echo "No new plugins to add in $REPO ($existing_count already tracked)." >&2
  exit 0
fi

existing_count=$(echo "$EXISTING" | grep -c . 2>/dev/null || echo 0)
echo "$REPO ($BRANCH): $existing_count tracked, ${#AVAILABLE[@]} available" >&2

# fzf multi-select
SELECTED=$(printf '%s\n' "${AVAILABLE[@]}" | fzf --prompt="Add plugins ($REPO)> " --height=~20 --reverse --multi)
if [ -z "$SELECTED" ]; then
  echo "Aborted." >&2
  exit 1
fi

# Add to YAML via shared helper
PLUGIN_FILE=$(mktemp)
echo "$SELECTED" > "$PLUGIN_FILE"
trap 'rm -f "$PLUGIN_FILE"' EXIT

"$SCRIPT_DIR/add-plugins-to-yaml" "$YAML_FILE" "$BRANCH" "$REPO" "$PLUGIN_FILE"
