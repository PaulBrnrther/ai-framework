#!/usr/bin/env python3
"""Parse plugin names from a ticket YAML for a given branch and repo.

Usage: parse-ticket-plugins <yaml_file> <branch> <repo>
Output: one plugin name per line
"""
import sys

yaml_file = sys.argv[1]
branch = sys.argv[2]
repo = sys.argv[3]

with open(yaml_file) as f:
    lines = f.readlines()

in_branch = False
in_repo = False
for line in lines:
    stripped = line.rstrip()
    if stripped == f"  {branch}:":
        in_branch = True
        continue
    if not in_branch:
        continue
    # Next branch
    if len(stripped) > 2 and stripped[0:2] == "  " and stripped[2] != " " and "/" in stripped:
        break
    if stripped.strip() == f"{repo}:":
        in_repo = True
        continue
    if in_repo:
        s = stripped.strip()
        # Another repo or non-plugin section
        if s.endswith(":") and not s.startswith("plugins") and not s.startswith("-") and s[0:1].isalpha():
            break
        # Plugin entry
        if s.startswith("- name: "):
            print(s[len("- name: "):])
        elif s.startswith("- ") and ":" not in s:
            print(s[2:].split("#")[0].strip())
