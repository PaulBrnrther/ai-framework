#!/usr/bin/env python3
"""Remove plugins from a ticket YAML file under a given branch and repo.

Usage: remove-plugins-from-yaml <yaml_file> <branch> <repo> <plugins_file>
  plugins_file: one plugin name per line
"""
import sys
import re

yaml_file = sys.argv[1]
branch = sys.argv[2]
repo = sys.argv[3]
plugin_file = sys.argv[4]

with open(plugin_file) as f:
    to_remove = set(line.strip() for line in f if line.strip())

if not to_remove:
    sys.exit(0)

with open(yaml_file) as f:
    lines = f.read().split("\n")

in_branch = False
in_repo = False
indices_to_remove = []

i = 0
while i < len(lines):
    stripped = lines[i].rstrip()

    if stripped == f"  {branch}:":
        in_branch = True
        i += 1
        continue
    if not in_branch:
        i += 1
        continue
    # Next branch
    if len(stripped) > 2 and stripped[0:2] == "  " and stripped[2] != " " and "/" in stripped:
        break

    if stripped.strip() == f"{repo}:":
        in_repo = True
        i += 1
        continue

    if in_repo:
        s = stripped.strip()
        # Another repo or non-plugin section
        if s.endswith(":") and not s.startswith("plugins") and not s.startswith("-") and s[0:1].isalpha():
            break

        # Check plugin entries
        plugin_name = None
        if s.startswith("- name: "):
            plugin_name = s[len("- name: "):]
        elif s.startswith("- ") and ":" not in s:
            plugin_name = s[2:].split("#")[0].strip()

        if plugin_name and plugin_name in to_remove:
            indices_to_remove.append(i)
            # Also remove jars_fetched line if present on next line
            if i + 1 < len(lines) and "jars_fetched:" in lines[i + 1]:
                indices_to_remove.append(i + 1)

    i += 1

if indices_to_remove:
    new_lines = [l for idx, l in enumerate(lines) if idx not in indices_to_remove]
    with open(yaml_file, "w") as f:
        f.write("\n".join(new_lines))
    print(f"Removed {len(to_remove)} plugin(s) from {repo}", file=sys.stderr)
else:
    print(f"No matching plugins found to remove from {repo}", file=sys.stderr)
